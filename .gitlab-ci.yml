stages:
  - kaniko
  - deploy

variables:
  APPNAME: "tosync"
  DOMAIN: "avapps.fr"
  ROOT_URL: "https://${APPNAME}.${DOMAIN}"
  IMAGE_TAG: "$(echo ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA})"
  INFO: "[meteor-docker]"

before_script:
  - if [[ ${CI_COMMIT_REF_NAME} = "master" && $CI_COMMIT_TAG ]];
    then IMAGE_TAG="$(echo stable-${CI_COMMIT_TAG})";
    else IMAGE_TAG="$(echo ${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA})";
    fi
  - echo ${INFO} Building image for '${CI_COMMIT_REF_NAME}' with tag '${IMAGE_TAG}'

kaniko-build:
  stage: kaniko
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo ${INFO} Starting docker image build with Kaniko for ${CI_COMMIT_REF_NAME} and pushing to ${IMAGE_TAG}
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${IMAGE_TAG}"
  only:
    - master
    - dev
    - dev-end
  tags:
    - docker

deploy-prod:
  stage: deploy
  variables:
    CHART_IMAGE_TAG: $IMAGE_TAG
  trigger:
    project: kubernetes/avapps/tosync-meteor-chart
    strategy: depend
  environment:
    name: production
    url: https://tosync.avapps.fr
  when: manual
  only:
    - master

deploy-dev:
  stage: deploy
  variables:
    CHART_IMAGE_TAG: $IMAGE_TAG
  trigger:
    project: kubernetes/avapps/tosync-meteor-chart
    strategy: depend
  environment:
    name: staging
    url: https://tosync.dev.avapps.fr
  only:
    - dev
    - dev-end
